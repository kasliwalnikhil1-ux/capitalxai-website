---
import type { CollectionEntry } from 'astro:content';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  title: string;
  description: string;
  author: string;
  authorAvatar?: string;
  authorBio?: string;
  publishDate: Date;
  updatedDate?: Date;
  tags?: string[];
  image?: string;
  imageAlt?: string;
  headings?: Heading[];
  currentSlug?: string;
  allPosts?: CollectionEntry<'blog'>[];
}

const {
  title,
  description,
  author,
  authorAvatar = '/images/avatar.jpg',
  authorBio,
  publishDate,
  updatedDate,
  tags = [],
  image,
  imageAlt,
  headings = [],
  currentSlug,
  allPosts = [],
} = Astro.props;

// --- Related Posts logic ---
function getRelatedPosts(
  currentSlug: string | undefined,
  currentTags: string[],
  allPosts: CollectionEntry<'blog'>[],
  max: number = 3
): CollectionEntry<'blog'>[] {
  if (!currentSlug) return [];

  // Exclude the current post
  const otherPosts = allPosts.filter((p) => p.slug !== currentSlug);

  // Score each post by number of shared tags
  const scored = otherPosts.map((post) => {
    const sharedTags = post.data.tags.filter((t: string) => currentTags.includes(t));
    return { post, score: sharedTags.length };
  });

  // Sort by score (most shared tags first), then by publishDate (newest first)
  scored.sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    return b.post.data.publishDate.getTime() - a.post.data.publishDate.getTime();
  });

  return scored.slice(0, max).map((s) => s.post);
}

const relatedPosts = getRelatedPosts(currentSlug, tags, allPosts);

const siteUrl = Astro.site?.toString() ?? 'https://capitalxai.com';
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).href;
const defaultOgImage = new URL('/Open Graph CapitalxAI.png', siteUrl).href;
const imageUrl = image ? new URL(image, siteUrl).href : defaultOgImage;

// JSON-LD structured data for BlogPosting
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description,
  author: {
    '@type': 'Person',
    name: author,
    image: new URL(authorAvatar, siteUrl).href,
    url: siteUrl,
  },
  publisher: {
    '@type': 'Organization',
    name: 'CapitalxAI',
    url: siteUrl,
    logo: {
      '@type': 'ImageObject',
      url: new URL('/capitalxai-logo.png', siteUrl).href,
    },
  },
  datePublished: publishDate.toISOString(),
  ...(updatedDate && { dateModified: updatedDate.toISOString() }),
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl,
  },
  image: imageUrl,
  keywords: tags.join(', '),
};

// BreadcrumbList structured data
const breadcrumbData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: siteUrl,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Blog',
      item: new URL('/blog', siteUrl).href,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: title,
      item: canonicalUrl,
    },
  ],
};

import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import TableOfContents from '../components/TableOfContents.astro';
import BlogAuthor from '../components/BlogAuthor.astro';
import AboutAuthor from '../components/AboutAuthor.astro';
import '../styles/global.css';
---

<BaseLayout
  title={`${title} | CapitalxAI Blog`}
  description={description}
  ogImage={image}
  ogType="article"
>
  <!-- Extra head meta for article -->
  <Fragment slot="head">
    <meta property="article:published_time" content={publishDate.toISOString()} />
    {updatedDate && <meta property="article:modified_time" content={updatedDate.toISOString()} />}
    {tags.map((tag) => <meta property="article:tag" content={tag} />)}
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} />
  </Fragment>

  <Header />

  <main class="blog-post" id="main-content">
    <article class="container blog-article" itemscope itemtype="https://schema.org/BlogPosting">
      <!-- Breadcrumb navigation -->
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <ol>
          <li><a href="/">Home</a></li>
          <li><a href="/blog">Blog</a></li>
          <li aria-current="page">{title}</li>
        </ol>
      </nav>

      <!-- Article header -->
      <header class="article-header">
        {tags.length > 0 && (
          <div class="article-tags">
            {tags.map((tag) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        )}
        <h1 class="article-title" itemprop="headline">{title}</h1>
        <p class="article-description">{description}</p>
        <div class="article-meta">
          <BlogAuthor
            author={author}
            avatar={authorAvatar}
            publishDate={publishDate}
            updatedDate={updatedDate}
          />
        </div>
      </header>

      <!-- Table of Contents -->
      {headings.length > 0 && <TableOfContents headings={headings} />}

      <!-- Article content -->
      <div class="article-content prose" itemprop="articleBody">
        <slot />
      </div>

      <!-- About the Author -->
      <AboutAuthor author={author} avatar={authorAvatar} bio={authorBio} />

      <!-- Back to blog link -->
      <footer class="article-footer">
        <a href="/blog" class="back-to-blog">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" />
          </svg>
          Back to all posts
        </a>
      </footer>
    </article>

    {relatedPosts.length > 0 && (
      <section class="related-posts container" aria-labelledby="related-posts-heading">
        <h2 id="related-posts-heading" class="related-posts-title">Related Posts</h2>
        <div class="related-grid">
          {relatedPosts.map((related) => {
            const relatedDate = related.data.publishDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            });
            return (
              <a href={`/blog/${related.slug}`} class="related-card">
                {related.data.image && (
                  <div class="related-card-image">
                    <img
                      src={related.data.image}
                      alt={related.data.imageAlt || related.data.title}
                      loading="lazy"
                      width="400"
                      height="225"
                    />
                  </div>
                )}
                <div class="related-card-body">
                  {related.data.tags.length > 0 && (
                    <div class="related-card-tags">
                      {related.data.tags.slice(0, 2).map((t: string) => (
                        <span class="tag">{t}</span>
                      ))}
                    </div>
                  )}
                  <h3 class="related-card-title">{related.data.title}</h3>
                  <time class="related-card-date" datetime={related.data.publishDate.toISOString()}>
                    {relatedDate}
                  </time>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    )}
  </main>

  <Footer />
</BaseLayout>

<style is:global>
  /* Blog post page styles */
  .blog-post {
    padding-block: 3rem 5rem;
    min-height: 60vh;
  }

  .blog-article {
    max-width: 48rem;
  }

  /* Breadcrumb */
  .breadcrumb ol {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    list-style: none;
    margin: 0 0 2.5rem;
    padding: 0;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  .breadcrumb li:not(:last-child)::after {
    content: '/';
    margin-left: 0.5rem;
    opacity: 0.4;
  }

  .breadcrumb a {
    color: var(--color-text-muted);
    transition: color var(--transition);
  }

  .breadcrumb a:hover {
    color: var(--color-accent-hover);
  }

  .breadcrumb li[aria-current='page'] {
    color: var(--color-text);
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 20ch;
  }

  /* Article header */
  .article-header {
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--color-border);
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
  }

  .tag {
    display: inline-block;
    padding: 0.2rem 0.7rem;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    color: var(--color-accent);
    background: var(--color-accent-muted);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 9999px;
    line-height: 1.5;
  }

  .article-title {
    margin: 0 0 1rem;
    font-size: clamp(1.75rem, 4vw, 2.75rem);
    font-weight: 700;
    letter-spacing: -0.025em;
    line-height: 1.15;
    color: var(--color-text);
  }

  .article-description {
    margin: 0 0 1.5rem;
    font-size: 1.15rem;
    line-height: 1.6;
    color: var(--color-text-muted);
  }

  .article-meta {
    font-size: 0.9rem;
    color: var(--color-text-muted);
  }

  /* Article footer */
  .article-footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .back-to-blog {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--color-text-muted);
    transition: color var(--transition);
  }

  .back-to-blog:hover {
    color: var(--color-accent-hover);
  }

  .back-to-blog svg {
    transition: transform var(--transition);
  }

  .back-to-blog:hover svg {
    transform: translateX(-3px);
  }

  /* Prose: Markdown content styles */
  .prose {
    font-size: 1.05rem;
    line-height: 1.8;
    color: rgba(255, 255, 255, 0.82);
  }

  .prose h2 {
    margin: 2.5rem 0 1rem;
    font-size: 1.6rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    line-height: 1.25;
    color: var(--color-text);
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .prose h3 {
    margin: 2rem 0 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    letter-spacing: -0.01em;
    line-height: 1.3;
    color: var(--color-text);
  }

  .prose h4 {
    margin: 1.5rem 0 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .prose p {
    margin: 0 0 1.25rem;
  }

  .prose a {
    color: var(--color-accent-hover);
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color var(--transition);
  }

  .prose a:hover {
    color: var(--color-accent);
  }

  .prose strong {
    font-weight: 600;
    color: var(--color-text);
  }

  .prose em {
    font-style: italic;
  }

  .prose ul,
  .prose ol {
    margin: 0 0 1.25rem;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.4rem;
  }

  .prose li::marker {
    color: var(--color-accent);
  }

  .prose blockquote {
    margin: 1.5rem 0;
    padding: 1rem 1.5rem;
    border-left: 3px solid var(--color-accent);
    background: var(--color-bg-elevated);
    border-radius: 0 var(--radius) var(--radius) 0;
    color: var(--color-text-muted);
    font-style: italic;
  }

  .prose blockquote p:last-child {
    margin-bottom: 0;
  }

  .prose code {
    font-family: var(--font-mono);
    font-size: 0.9em;
    padding: 0.15em 0.4em;
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-accent-hover);
  }

  .prose pre {
    margin: 1.5rem 0;
    padding: 1.25rem;
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    overflow-x: auto;
  }

  .prose pre code {
    padding: 0;
    background: none;
    border: none;
    font-size: 0.88rem;
    color: var(--color-text);
  }

  .prose hr {
    margin: 2.5rem 0;
    border: none;
    border-top: 1px solid var(--color-border);
  }

  .prose table {
    width: 100%;
    margin: 1.5rem 0;
    border-collapse: collapse;
    font-size: 0.95rem;
  }

  .prose th,
  .prose td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .prose th {
    font-weight: 600;
    color: var(--color-text);
    background: var(--color-bg-elevated);
  }

  .prose tr:hover td {
    background: rgba(255, 255, 255, 0.02);
  }

  .prose img {
    margin: 1.5rem 0;
    border-radius: var(--radius);
    border: 1px solid var(--color-border);
  }

  /* Related Posts */
  .related-posts {
    max-width: 64rem;
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 1px solid var(--color-border);
  }

  .related-posts-title {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--color-text);
    margin: 0 0 1.75rem;
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  .related-card {
    display: flex;
    flex-direction: column;
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    overflow: hidden;
    text-decoration: none;
    color: inherit;
    transition: border-color var(--transition), transform var(--transition), box-shadow var(--transition);
  }

  .related-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  }

  .related-card-image {
    aspect-ratio: 16 / 9;
    overflow: hidden;
    background: var(--color-bg);
  }

  .related-card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition);
  }

  .related-card:hover .related-card-image img {
    transform: scale(1.04);
  }

  .related-card-body {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    flex: 1;
  }

  .related-card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .related-card-tags .tag {
    font-size: 0.65rem;
    padding: 0.15rem 0.5rem;
  }

  .related-card-title {
    font-size: 1.05rem;
    font-weight: 600;
    line-height: 1.35;
    color: var(--color-text);
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .related-card-date {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-top: auto;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .blog-post {
      padding-block: 1.5rem 3rem;
    }

    .article-title {
      font-size: 1.5rem;
    }

    .article-description {
      font-size: 1rem;
    }

    .prose {
      font-size: 1rem;
    }

    .prose h2 {
      font-size: 1.35rem;
    }

    .prose h3 {
      font-size: 1.15rem;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }

    .related-posts {
      margin-top: 2.5rem;
      padding-top: 2rem;
    }

    .related-posts-title {
      font-size: 1.25rem;
    }
  }

  @media (min-width: 641px) and (max-width: 900px) {
    .related-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
